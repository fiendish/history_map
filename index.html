<!DOCTYPE html>
<html>
<head>
    <title>leaflet-map-csv</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <!-- leaflet.js -->
    <link   rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
        integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
        crossorigin=""/>
    <script   src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
        integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
        crossorigin=""></script>

    <!-- Use leaflet-omnivore for the dsv file to GeoJSON conversion -->
    <script src='leaflet-omnivore.min.js'></script>

    <!-- csv2geojson will convert GeoJSON collections of points to linestrings -->
    <script src='csv2geojson.js'></script>

    <!-- easy access to basemap providers -->
    <script src='leaflet-providers.min.js'></script>

    <script src='MovingMarker.js'></script>

    <script src="Leaflet.Geodesic.js"></script>

    <!-- Full window -->
    <style>
        body { margin:0; padding:0; }
        #map { position: absolute; top:0; bottom:0; right:0; left:0; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>

    var map = L.map(
        'map',
        {
            scrollWheelZoom: true
        }
    );

    var baselayers = {
        'Gray': L.tileLayer(
            'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png',
            {
                noWrap: false,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
            }
        ).addTo(map),
        'Watercolor': L.tileLayer.provider('Stamen.Watercolor'),
        'None': L.tileLayer('')
    };

    var step = 0;
    function rainbow(numOfSteps) {
        // This function generates vibrant, "evenly spaced" colours (i.e. no clustering). This is ideal for creating easily distinguishable vibrant markers in Google Maps and other apps.
        // Adam Cole, 2011-Sept-14
        // HSV to RBG adapted from: http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript
        var r, g, b;
        var h = ++step / numOfSteps;
        var i = ~~(h * 6);
        var f = h * 6 - i;
        var q = 1 - f;
        switch(i % 6){
            case 0: r = 1; g = f; b = 0; break;
            case 1: r = q; g = 1; b = 0; break;
            case 2: r = 0; g = 1; b = f; break;
            case 3: r = 0; g = q; b = 1; break;
            case 4: r = f; g = 0; b = 1; break;
            case 5: r = 1; g = 0; b = q; break;
        }
        var c = "#" + ("00" + (~ ~(r * 255)).toString(16)).slice(-2) + ("00" + (~ ~(g * 255)).toString(16)).slice(-2) + ("00" + (~ ~(b * 255)).toString(16)).slice(-2);
        return (c);
    }

    var layerStyle = {
        onEachFeature: function(feature, layer) {
            layer.bindPopup(feature.properties['name_as_written']);
            layer.on('mouseover', function (e) {
                this.openPopup();
            });
            layer.on('mouseout', function (e) {
                this.closePopup();
            });
        },
        pointToLayer: function (feature, latlng) {
            var ifile = feature.properties['icon'];
            var ico = (!ifile || (ifile =='none')) ? 'blue.png' : ifile // default to blue
            return L.marker(
                latlng,
                {
                    icon:L.icon({
                        iconUrl: ico,
                        shadowUrl: 'shadow.png',
                        iconSize: [25,41],
                        shadowSize:   [41, 41],
                        shadowAnchor: [13, 41],
                        iconAnchor: [13,41]
                    }),
                    opacity: ifile == 'none' ? 0 : 100
                }
            );
        }
    }

    var all_layers = L.featureGroup().addTo(map);
    var all_boats = L.featureGroup().addTo(map);

    var boatIcon = L.icon({
        iconUrl: 'boat-48.png',
        iconAnchor: [24, 48]
    });

    var geolatlngs, geocurve, path;
    var connectDots = function() {
        path = csv2geojson.toLine(this.toGeoJSON()); // geojson object
        geolatlngs = L.GeoJSON.coordsToLatLngs(path.features[0].geometry.coordinates); // array of latlng objects
        geopolyline = L.geodesic(
            [geolatlngs],
            {
                weight: 7,
                opacity: 0.5,
                color: 'blue',
                steps: 50
            }
        );
        this.addData(geopolyline.toGeoJSON());
//        this.addData(path);
        this.setStyle({color: rainbow(data_files.length)});

        all_layers.addLayer(this);

        map.fitBounds(all_layers.getBounds());

        var boat = L.Marker.movingMarker(
            geopolyline.getLatLngs()[0],
            geopolyline.getLatLngs()[0].length*100,
            {
                autostart: true,
                icon: boatIcon,
                onEnd: function() { this.stop(); this.start(); }
             }
        ).addTo(all_boats);
    }

    var data_files = [
        ['Chevalier de Ternay (2)', 'data2.csv'],
        ['La Brillane (3)', 'data3.csv'],
        ['Souillac (4)', 'data4.csv'],
        ["d'Entrecasteaux (5)", 'data5.csv'],
        ["Conway (6)", 'data6.csv'],
        ["Malartic (7)", 'data7.csv'],
        ["Decarn (8)", 'data8.csv']
    ]

    var overlays = {}
    for (var i = 0; i < data_files.length; i++) {
        var file = data_files[i];
        var file_name = file[0];
        var file_path = file[1];
        overlays[file_name] = omnivore.csv(
            file_path,
            {latfield: 'latitude', lonfield: 'longitude', delimiter: ';'},
            L.geoJson(null, layerStyle)
        ).on('ready', connectDots);
    }

    overlays['Boats (LOL)'] = all_boats;

    L.control.layers(baselayers, overlays).addTo(map);
</script>
</body>
</html>
